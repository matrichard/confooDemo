@{
	ViewBag.Title = "Home Page";
}

<div class="jumbotron">
	<h1>SignalR Demo</h1>
	<p class="lead">A simple demo that displays the number of time each button is clicked by anyone connected</p>
	<p>
		<a href="http://www.asp.net/signalr" class="btn btn-primary btn-lg">Learn more &raquo;</a>
	</p>
	<p>
		<a class="btn btn-default btn-lg" href="http://www.matrichard.com"><i class="icon-pencil"></i>My Blog</a>
		<a href="https://twitter.com/matrichard5" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @@matrichard5</a>
		<script>
			!function(d, s, id) {
				var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
				if (!d.getElementById(id)) {
					js = d.createElement(s);
					js.id = id;
					js.src = p + '://platform.twitter.com/widgets.js';
					fjs.parentNode.insertBefore(js, fjs);
				}
			}(document, 'script', 'twitter-wjs');
		</script>
		<a class="btn btn-default btn-lg" href="https://github.com/matrichard/confooDemo"><i class="icon-github"></i>Code on Github</a>
	</p>
</div>
<div ng-controller="OptionsController as ctrl">
	<div class="row">
		@*<div class="col-md-4">
			<p>
				
			</p>
		</div>*@
		<div class="col-lg-offset-4 col-lg-4">
			<p>
				<a class="btn btn-default" ng-click="ctrl.incrementOption('a')">Option A</a> {{ctrl.model.a}}
				<a class="btn btn-default" ng-click="ctrl.incrementOption('b')">Choose B</a> {{ctrl.model.b}}
				<a class="btn btn-default" ng-click="ctrl.incrementOption('c')">Choose C</a> {{ctrl.model.c}}
			</p>
		</div>
		@*<div class="col-md-4">
			<p>
				
			</p>
		</div>*@
	</div>
	<div class="row">
		<div class="col-lg-6">
			<canvas id="doughnut" class="chart chart-doughnut" data="ctrl.data"
					labels="ctrl.labels" legend="true"></canvas>
		</div>
		<div class="col-lg-6">
			<canvas id="pie" class="chart chart-pie" data="ctrl.data"
					labels="ctrl.labels" legend="true"></canvas>
		</div>
	</div>
</div>
@section scripts
{
	<!--Reference the SignalR library. -->
	<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
	<!--Reference the autogenerated SignalR hub script. -->
	<script src="~/signalr/hubs"></script>
	<script>
		(function(angular) {
			var confooApp = angular.module('confooApp', ['chart.js']);
			confooApp
				.factory('SignalRHubProxyFactory', function($rootScope) {
					var hub = $.connection.optionHub;
					$.connection.hub.start().done(function() {
						console.log('hub ready');
					});

					function signalRHubProxyFactory(callback) {

						hub.client.updateOption = function(data) {
							$rootScope.$apply(function() {
								callback(data);
							});
						}

						return {
							incrementOption: function(option) {
								hub.server.incrementOption(option);
							}
						}
					};

					return signalRHubProxyFactory;
				})
				.controller('OptionsController', [
					'SignalRHubProxyFactory', function(hubFactory) {
						var vm = this;
						vm.model = {};
						vm.model.a = @OptionIncrementer.Count("a");
						vm.model.b = @OptionIncrementer.Count("b");
						vm.model.c = @OptionIncrementer.Count("c");
						vm.series = ['First', 'Second'];
						vm.labels = ["A", "B", "C"];
						vm.data = [vm.model.a, vm.model.b, vm.model.c];

						vm.incrementOption = function(option) {
							hub.incrementOption(option);
						}

						vm.increment = function(data) {
							vm.model[data.option] = data.optionCount;
							vm.data = [vm.model.a, vm.model.b, vm.model.c];
						}

						var hub = hubFactory(this.increment);
					}
				]);
		})(angular);
	</script>
}
